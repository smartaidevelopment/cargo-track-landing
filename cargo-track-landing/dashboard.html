<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="CargoTrack Pro Dashboard - Monitor your cargo tracking devices in real-time">
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">
    <title>Dashboard - CargoTrack Pro</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="auth.js"></script>
    <script>
        // Check if using file:// protocol (won't work properly)
        if (window.location.protocol === 'file:') {
            document.write(`
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 99999; display: flex; align-items: center; justify-content: center; font-family: Arial, sans-serif;">
                    <div style="text-align: center; max-width: 600px; padding: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                        <h1 style="color: #ef4444; margin-bottom: 1rem;">Cannot Use File Protocol</h1>
                        <p style="font-size: 1.1rem; margin-bottom: 1.5rem; color: #333;">
                            This application requires a web server to work properly. The <code>file://</code> protocol doesn't support localStorage, authentication, and other features.
                        </p>
                        <div style="background: #f3f4f6; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                            <h2 style="margin-bottom: 1rem; color: #1f2937;">Use This URL Instead:</h2>
                            <div style="background: #fff; padding: 1rem; border-radius: 0.25rem; border: 2px solid #3b82f6; font-size: 1.2rem; font-weight: bold; color: #3b82f6; word-break: break-all;">
                                http://localhost:8000
                            </div>
                        </div>
                        <div style="background: #dbeafe; padding: 1rem; border-radius: 0.5rem; text-align: left;">
                            <h3 style="margin-bottom: 0.5rem; color: #1e40af;">Quick Start:</h3>
                            <ol style="margin-left: 1.5rem; color: #1e3a8a; line-height: 1.8;">
                                <li>Open terminal in the project folder</li>
                                <li>Run: <code style="background: #fff; padding: 0.2rem 0.5rem; border-radius: 0.25rem;">python3 -m http.server 8000</code></li>
                                <li>Open browser and go to: <strong>http://localhost:8000</strong></li>
                            </ol>
                        </div>
                    </div>
                </div>
            `);
            throw new Error('File protocol not supported');
        }
        
        // Immediate authentication check before page renders
        // Use a single, coordinated check to prevent flickering
        (function() {
            // Prevent multiple checks
            if (window.authCheckDone || window.authRedirectInProgress || window.authVerified) {
                return;
            }
            window.authCheckDone = true;
            
            // Wait for auth.js to be loaded and localStorage to be ready
            function performAuthCheck() {
                // Check if auth.js functions are available
                if (typeof isAuthenticated === 'undefined') {
                    // Wait a bit more for auth.js to load
                    setTimeout(performAuthCheck, 50);
                    return;
                }
                
                try {
                    // Use the isAuthenticated function from auth.js
                    if (isAuthenticated()) {
                        // Auth is valid - mark as verified immediately
                        window.authVerified = true;
                        // Hide overlay smoothly when DOM is ready
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', hideOverlay);
                        } else {
                            hideOverlay();
                        }
                    } else {
                        // Not authenticated - redirect to login
                        window.authRedirectInProgress = true;
                        const overlay = document.getElementById('authLoadingOverlay');
                        if (overlay) {
                            overlay.innerHTML = '<div style="text-align: center;"><div style="font-size: 2rem; margin-bottom: 1rem;">üîí</div><div>Redirecting to login...</div></div>';
                        }
                        setTimeout(() => {
                            window.location.replace('login.html');
                        }, 300);
                    }
                } catch (e) {
                    console.error('Auth check error:', e);
                    window.authRedirectInProgress = true;
                    const overlay = document.getElementById('authLoadingOverlay');
                    if (overlay) {
                        overlay.innerHTML = '<div style="text-align: center;"><div style="font-size: 2rem; margin-bottom: 1rem;">‚ùå</div><div>Error. Redirecting...</div></div>';
                    }
                    setTimeout(() => {
                        window.location.replace('login.html');
                    }, 300);
                }
            }
            
            function hideOverlay() {
                const overlay = document.getElementById('authLoadingOverlay');
                if (overlay) {
                    overlay.classList.add('hidden');
                    setTimeout(() => {
                        overlay.style.display = 'none';
                    }, 300);
                }
            }
            
            // Start auth check after a short delay to ensure localStorage is synced
            setTimeout(performAuthCheck, 100);
        })();
    </script>
    <style>
        /* Hide body content until auth is verified */
        body.dashboard > *:not(#authLoadingOverlay) {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        body.dashboard.auth-verified > *:not(#authLoadingOverlay) {
            opacity: 1;
            visibility: visible;
        }
        
        /* Loading overlay styles */
        #authLoadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease-in-out;
        }
        
        #authLoadingOverlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dashboard">
    <!-- Loading overlay to prevent flicker during auth check -->
    <div id="authLoadingOverlay">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <div style="font-size: 1.1rem; color: #4b5563; font-weight: 500;">Loading dashboard...</div>
            <div style="font-size: 0.875rem; color: #9ca3af; margin-top: 0.5rem;">Please wait</div>
        </div>
    </div>
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <i class="fas fa-satellite-dish"></i>
                <span>CargoTrack Pro</span>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <a href="#dashboard" class="nav-item active" data-section="dashboard">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="#devices" class="nav-item" data-section="devices">
                <i class="fas fa-map-marked-alt"></i>
                <span>Live Tracking</span>
            </a>
            <a href="#alerts" class="nav-item" data-section="alerts">
                <i class="fas fa-bell"></i>
                <span>Alerts</span>
                <span class="badge" id="alertsBadge">0</span>
            </a>
            <a href="#analytics" class="nav-item" data-section="analytics">
                <i class="fas fa-chart-line"></i>
                <span>Analytics</span>
            </a>
            <a href="#devices-management" class="nav-item" data-section="devices-management">
                <i class="fas fa-cog"></i>
                <span>Devices</span>
            </a>
            <a href="#settings" class="nav-item" data-section="settings">
                <i class="fas fa-user-cog"></i>
                <span>Settings</span>
            </a>
            <a href="#privacy" class="nav-item" data-section="privacy">
                <i class="fas fa-shield-alt"></i>
                <span>Privacy & Data</span>
            </a>
            <a href="#billing" class="nav-item" data-section="billing">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>Billing & Invoices</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <span class="user-name" id="userName">User</span>
                    <span class="user-email" id="userEmail">user@email.com</span>
                </div>
            </div>
            <button class="btn btn-outline btn-small" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Bar -->
        <header class="topbar">
            <div class="topbar-left">
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
            </div>
            <div class="topbar-right">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search devices...">
                </div>
                <div class="notifications">
                    <button class="notification-btn" id="notificationBtn" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-bell"></i>
                        <span class="notification-count" id="notificationCount">0</span>
                    </button>
                    <div class="notification-dropdown" id="notificationDropdown" aria-hidden="true">
                        <div class="notification-dropdown-header">
                            <span>Notifications</span>
                            <div class="notification-dropdown-actions">
                                <button class="notification-action" type="button" id="notificationMarkAllRead">Mark all read</button>
                                <button class="notification-action" type="button" id="notificationViewAll">View All</button>
                            </div>
                        </div>
                        <div class="notification-dropdown-body" id="notificationDropdownBody">
                            <p class="empty-state">No alerts at this time</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalDevices">0</h3>
                        <p>Active Devices</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="activeShipments">0</h3>
                        <p>Active Shipments</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="activeAlerts">0</h3>
                        <p>Active Alerts</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="completedShipments">0</h3>
                        <p>Completed Today</p>
                    </div>
                </div>
            </div>

            <!-- Global Live Map -->
            <div class="dashboard-card full-width" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <h2><i class="fas fa-globe"></i> Global Live Tracking Map</h2>
                    <div class="card-actions">
                        <button class="btn btn-outline btn-small" id="refreshGlobalMapBtn" title="Refresh Map">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-outline btn-small" id="toggleMapAutoRefresh" title="Auto Refresh">
                            <i class="fas fa-play"></i> Auto Refresh
                        </button>
                    </div>
                </div>
                <div id="globalMap" class="map-container" style="height: 500px; width: 100%; border-radius: 0.5rem; overflow: hidden;"></div>
                <div class="map-legend" style="padding: 1rem; background: #f9fafb; border-top: 1px solid #e5e7eb;">
                    <div style="display: flex; gap: 2rem; flex-wrap: wrap; font-size: 0.875rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 16px; height: 16px; background: #10b981; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                            <span>Active Tracker</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 16px; height: 16px; background: #ef4444; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                            <span>Inactive/Alert</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 16px; height: 16px; background: #f59e0b; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                            <span>Warning</span>
                        </div>
                        <div id="mapStats" style="margin-left: auto; color: var(--text-light);">
                            <span id="mapDeviceCount">0</span> devices tracked
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2>Recent Activity</h2>
                        <button class="btn-icon">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                    <div class="activity-list" id="activityList">
                        <!-- Activity items will be populated by JS -->
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2>Temperature Monitoring</h2>
                        <button class="btn-icon">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h2>Device Status Overview</h2>
                    <div class="card-actions">
                        <button class="btn btn-outline btn-small">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <button class="btn btn-outline btn-small">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Device ID</th>
                                <th>Status</th>
                                <th>Location</th>
                                <th>Temperature</th>
                                <th>Last Update</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="devicesTableBody">
                            <!-- Table rows will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Live Tracking Section -->
        <section id="devices" class="content-section">
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h2>Live Tracking Map</h2>
                    <div class="card-actions">
                        <button class="btn btn-outline btn-small" id="refreshMapBtn">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div id="map" class="map-container"></div>
            </div>
            
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2>Device List</h2>
                    </div>
                    <div class="device-list" id="deviceList">
                        <!-- Device items will be populated by JS -->
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2>Selected Device Details</h2>
                        <button class="btn btn-outline btn-small" id="viewFullDetailsBtn" style="display: none;" onclick="viewFullDeviceDetails()">
                            <i class="fas fa-info-circle"></i> Full Details
                        </button>
                    </div>
                    <div class="device-details" id="deviceDetails">
                        <p class="empty-state">Select a device to view details</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Alerts Section -->
        <section id="alerts" class="content-section">
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h2>Alerts & Notifications</h2>
                    <div class="card-actions">
                        <button class="btn btn-primary btn-small" id="markAllReadBtn">
                            <i class="fas fa-check-double"></i> Mark All Read
                        </button>
                    </div>
                </div>
                <div class="alerts-container" id="alertsContainer">
                    <!-- Alerts will be populated by JS -->
                </div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section id="analytics" class="content-section">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2>Shipment Trends</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="shipmentTrendsChart"></canvas>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2>Alert Distribution</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="alertDistributionChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h2>Performance Metrics</h2>
                </div>
                <div class="metrics-grid">
                    <div class="metric-item">
                        <h3>Average Delivery Time</h3>
                        <p class="metric-value">-</p>
                        <span class="metric-change">No data yet</span>
                    </div>
                    <div class="metric-item">
                        <h3>On-Time Delivery Rate</h3>
                        <p class="metric-value">-</p>
                        <span class="metric-change">No data yet</span>
                    </div>
                    <div class="metric-item">
                        <h3>Temperature Compliance</h3>
                        <p class="metric-value">-</p>
                        <span class="metric-change">No data yet</span>
                    </div>
                    <div class="metric-item">
                        <h3>Alert Response Time</h3>
                        <p class="metric-value">-</p>
                        <span class="metric-change">No data yet</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Devices Management Section -->
        <section id="devices-management" class="content-section">
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h2>Devices</h2>
                    <button class="btn btn-primary btn-small" id="addDeviceBtn">
                        <i class="fas fa-plus"></i> Add Device
                    </button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Device ID</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Network</th>
                                <th>Sensors</th>
                                <th>Package</th>
                                <th>Registered</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="devicesManagementTableBody">
                            <!-- Table rows will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Device Details Modal -->
            <div id="deviceModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modalTitle">Device Details</h2>
                        <button class="modal-close" id="closeModal">&times;</button>
                    </div>
                    <div class="modal-body" id="deviceModalBody">
                        <!-- Device details will be populated by JS -->
                    </div>
                </div>
            </div>
            
            <!-- Device Form Modal -->
            <div id="deviceFormModal" class="modal">
                <div class="modal-content modal-large">
                    <div class="modal-header">
                        <h2 id="deviceFormTitle">Add New Device</h2>
                        <button class="modal-close" id="closeDeviceFormModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="deviceForm" class="device-form">
                            <!-- Step 1: Basic Information -->
                            <div id="step1" class="form-step active">
                                <div class="step-header">
                                    <h3><i class="fas fa-info-circle"></i> Step 1: Basic Information</h3>
                                    <span class="step-indicator">1 of 2</span>
                                </div>
                                <div class="form-section">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="deviceGroup">Group *</label>
                                            <input type="text" id="deviceGroup" name="deviceGroup" required placeholder="Enter device group">
                                            <small>e.g., Warehouse A, Fleet 1, Cold Chain</small>
                                        </div>
                                        <div class="form-group">
                                            <label for="deviceType">Device Type *</label>
                                            <select id="deviceType" name="deviceType" required>
                                                <option value="">Select device type</option>
                                                <option value="Tracker">Tracker</option>
                                                <option value="Sensor">Sensor</option>
                                                <option value="Gateway">Gateway</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="deviceId">Device ID *</label>
                                            <input type="text" id="deviceId" name="deviceId" required placeholder="Enter device ID">
                                            <small>Unique identifier for this device</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="step-actions">
                                    <button type="button" class="btn btn-outline" onclick="closeDeviceFormModal()">Cancel</button>
                                    <button type="button" class="btn btn-primary" onclick="goToStep2()">
                                        Continue <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Step 2: Name, Asset and Configuration -->
                            <div id="step2" class="form-step">
                                <div class="step-header">
                                    <h3><i class="fas fa-tag"></i> Step 2: Name, Asset and Configuration</h3>
                                    <span class="step-indicator">2 of 2</span>
                                </div>
                                <div class="form-section">
                                    <h4><i class="fas fa-info-circle"></i> Name and Asset</h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="deviceName">Device Name</label>
                                            <input type="text" id="deviceName" name="deviceName" placeholder="Enter device name (optional)">
                                            <small>Optional: A friendly name for this device</small>
                                        </div>
                                        <div class="form-group">
                                            <label for="deviceAsset">Asset</label>
                                            <input type="text" id="deviceAsset" name="deviceAsset" placeholder="Enter asset (optional)">
                                            <small>Optional: Associated asset or equipment</small>
                                        </div>
                                    </div>
                                </div>
                            
                            <!-- Network Connectivity -->
                            <div class="form-section">
                                <h3><i class="fas fa-network-wired"></i> Network Connectivity</h3>
                                <p class="form-help">Select all network types supported by this device</p>
                                <div class="checkbox-grid">
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="networks" value="GPS/GNSS" checked>
                                        <span><i class="fas fa-satellite"></i> GPS/GNSS</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="networks" value="4G LTE">
                                        <span><i class="fas fa-signal"></i> 4G LTE</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="networks" value="2G">
                                        <span><i class="fas fa-signal"></i> 2G</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="networks" value="3G">
                                        <span><i class="fas fa-signal"></i> 3G</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="networks" value="5G">
                                        <span><i class="fas fa-signal"></i> 5G</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="networks" value="LTE Cat-M1">
                                        <span><i class="fas fa-signal"></i> LTE Cat-M1</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="networks" value="BLE">
                                        <span><i class="fas fa-bluetooth"></i> BLE</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="networks" value="NFC">
                                        <span><i class="fas fa-credit-card"></i> NFC</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 4G LTE Tracker Settings -->
                            <div class="form-section">
                                <h3><i class="fas fa-signal"></i> 4G LTE Tracker</h3>
                                <p class="form-help">Optional LTE details for tracker devices</p>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="lteImei">IMEI</label>
                                        <input type="text" id="lteImei" name="lteImei" placeholder="15-digit IMEI" pattern="[0-9]{15}">
                                    </div>
                                    <div class="form-group">
                                        <label for="lteSimIccid">SIM ICCID</label>
                                        <input type="text" id="lteSimIccid" name="lteSimIccid" placeholder="18-22 digit ICCID" pattern="[0-9]{18,22}">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="lteCarrier">Carrier</label>
                                        <input type="text" id="lteCarrier" name="lteCarrier" placeholder="Carrier name (e.g., AT&T, Vodafone)">
                                    </div>
                                    <div class="form-group">
                                        <label for="lteApn">APN</label>
                                        <input type="text" id="lteApn" name="lteApn" placeholder="APN (e.g., internet, iot)">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="lteDataFormat">Data Format</label>
                                        <select id="lteDataFormat" name="lteDataFormat">
                                            <option value="json">JSON</option>
                                            <option value="nmea">NMEA</option>
                                            <option value="binary">Binary</option>
                                            <option value="codec8">Codec 8</option>
                                            <option value="codec8ext">Codec 8 Extended</option>
                                            <option value="auto">Auto-detect</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="lteDataLogFrequency">Reporting Interval (ms)</label>
                                        <input type="number" id="lteDataLogFrequency" name="lteDataLogFrequency" value="5000" min="1000" max="60000" step="1000">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sensors -->
                            <div class="form-section">
                                <h3><i class="fas fa-microchip"></i> Sensors</h3>
                                <p class="form-help">Select sensors available on this device</p>
                                <div class="checkbox-grid">
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="sensors" value="temperature" checked>
                                        <span><i class="fas fa-thermometer-half"></i> Temperature</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="sensors" value="humidity">
                                        <span><i class="fas fa-tint"></i> Humidity</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="sensors" value="accelerometer">
                                        <span><i class="fas fa-compress-arrows-alt"></i> Accelerometer</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="sensors" value="gyroscope">
                                        <span><i class="fas fa-sync"></i> Gyroscope</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="sensors" value="magnetometer">
                                        <span><i class="fas fa-compass"></i> Magnetometer</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="sensors" value="pressure">
                                        <span><i class="fas fa-weight"></i> Pressure</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="sensors" value="light">
                                        <span><i class="fas fa-lightbulb"></i> Light</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="sensors" value="proximity">
                                        <span><i class="fas fa-hand-paper"></i> Proximity</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- GPS/GNSS Tracker Settings -->
                            <div class="form-section">
                                <h3><i class="fas fa-satellite"></i> GPS/GNSS Tracker Settings</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="gpsStatus">GPS Status</label>
                                        <select id="gpsStatus" name="gpsStatus">
                                            <option value="Active">Active</option>
                                            <option value="Inactive">Inactive</option>
                                            <option value="Searching">Searching</option>
                                        </select>
                                        <small>Satellites, accuracy, and coordinates update automatically from live GPS.</small>
                                    </div>
                                </div>
                            </div>
                            
                            
                                <!-- Form Actions -->
                                <div class="step-actions">
                                    <button type="button" class="btn btn-outline" onclick="goToStep1()">
                                        <i class="fas fa-arrow-left"></i> Back
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Device
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Privacy & Data Section -->
        <section id="privacy" class="content-section">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2><i class="fas fa-download"></i> Export My Data</h2>
                    </div>
                    <div class="card-content">
                        <p>Request a copy of all your personal data stored in our system (GDPR Right to Access).</p>
                        <button class="btn btn-primary" onclick="exportMyData()">
                            <i class="fas fa-download"></i> Export My Data
                        </button>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2><i class="fas fa-trash"></i> Delete My Account</h2>
                    </div>
                    <div class="card-content">
                        <p>Permanently delete your account and all associated data (GDPR Right to be Forgotten).</p>
                        <button class="btn btn-outline" style="border-color: #ef4444; color: #ef4444;" onclick="deleteMyAccount()">
                            <i class="fas fa-trash"></i> Delete Account
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h2><i class="fas fa-shield-alt"></i> Privacy Information</h2>
                </div>
                <div class="card-content">
                    <h3>Data Protection</h3>
                    <ul>
                        <li>Your data is encrypted in transit (TLS 1.3)</li>
                        <li>Data at rest is encrypted</li>
                        <li>We comply with GDPR regulations</li>
                        <li>You have the right to access, export, and delete your data</li>
                    </ul>
                    <h3 style="margin-top: 1.5rem;">Your Rights</h3>
                    <ul>
                        <li><strong>Right to Access:</strong> Request a copy of your data</li>
                        <li><strong>Right to Rectification:</strong> Correct inaccurate data</li>
                        <li><strong>Right to Erasure:</strong> Delete your account and data</li>
                        <li><strong>Right to Data Portability:</strong> Export your data</li>
                    </ul>
                    <p style="margin-top: 1.5rem;">
                        <a href="privacy-policy.html" target="_blank">Read full Privacy Policy</a>
                    </p>
                </div>
            </div>
        </section>

        <!-- Billing & Invoices Section -->
        <section id="billing" class="content-section">
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h2><i class="fas fa-file-invoice-dollar"></i> Invoices & Receipts</h2>
                    <div class="card-actions">
                        <button class="btn btn-outline btn-small" onclick="refreshInvoices()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Date</th>
                                <th>Package</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Payment Method</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTable">
                            <!-- Invoices will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2>Billing Summary</h2>
                    </div>
                    <div class="billing-summary">
                        <div class="summary-item">
                            <span class="summary-label">Total Paid</span>
                            <span class="summary-value" id="totalPaid">$0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">This Month</span>
                            <span class="summary-value" id="monthlyPaid">$0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Pending</span>
                            <span class="summary-value" id="pendingAmount">$0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Total Invoices</span>
                            <span class="summary-value" id="totalInvoices">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2>Payment Methods</h2>
                    </div>
                    <div class="payment-methods-list" id="paymentMethodsList">
                        <!-- Payment methods will be populated by JS -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="content-section">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2>Account Settings</h2>
                    </div>
                    <form class="settings-form" id="accountSettingsForm">
                        <div class="form-group">
                            <label>Company Name</label>
                            <input type="text" id="settingsCompany" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="settingsEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="settingsPhone" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
                
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2>Notification Preferences</h2>
                    </div>
                    <form class="settings-form" id="notificationSettingsForm">
                        <div class="form-section">
                            <h4 style="margin-bottom: 1rem; color: var(--text-dark);">Alert Notifications</h4>
                            <div class="form-group checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="alertNotifications" checked>
                                    <span>Device Alerts & Warnings</span>
                                </label>
                            </div>
                            <div class="form-group checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="emailAlerts" checked>
                                    <span>Email Alerts</span>
                                </label>
                            </div>
                            <div class="form-group checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="smsAlerts">
                                    <span>SMS Alerts</span>
                                </label>
                            </div>
                            <div class="form-group checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="pushNotifications" checked>
                                    <span>Push Notifications</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-section" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 1rem; color: var(--text-dark);">System Notifications</h4>
                            <div class="form-group checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="systemNotifications" checked>
                                    <span>System Updates & Maintenance</span>
                                </label>
                            </div>
                            <div class="form-group checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="paymentThankYou" checked>
                                    <span>Payment Confirmation Emails</span>
                                </label>
                                <small style="display: block; margin-top: 0.25rem; color: var(--text-light);">Receive thank you messages after successful payments</small>
                            </div>
                            <div class="form-group checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="subscriptionReminder" checked>
                                    <span>Subscription Renewal Reminders</span>
                                </label>
                                <small style="display: block; margin-top: 0.25rem; color: var(--text-light);">Get reminders before subscription expiration</small>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" style="margin-top: 1.5rem;">Save Preferences</button>
                    </form>
                </div>
            </div>
            
            <!-- API Keys for Integrations -->
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h2><i class="fas fa-key"></i> API Keys for Integrations</h2>
                    <button class="btn btn-outline btn-small" id="generateApiKeyBtn">
                        <i class="fas fa-plus"></i> Generate New API Key
                    </button>
                </div>
                <div class="api-keys-container">
                    <p style="margin-bottom: 1rem; color: var(--text-light);">
                        Generate API keys to connect your CargoTrack Pro account with external systems, ERPs, or custom integrations.
                    </p>
                    <div id="userApiKeysList" class="api-keys-list">
                        <!-- API keys will be populated here -->
                    </div>
                </div>
            </div>
            
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h2><i class="fas fa-headset"></i> Contact Support</h2>
                </div>
                <div class="support-contact-container">
                    <div class="support-methods">
                        <div class="support-method-card">
                            <div class="support-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <h3>AI Support Chat</h3>
                            <p>Get instant help from our AI assistant</p>
                            <button class="btn btn-primary" onclick="openSupportChat()">
                                <i class="fas fa-robot"></i> Open Chat
                            </button>
                        </div>
                        
                        <div class="support-method-card">
                            <div class="support-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <h3>Email Support</h3>
                            <p>Send us an email and we'll respond within 24 hours</p>
                            <button class="btn btn-outline" onclick="openEmailSupport()">
                                <i class="fas fa-paper-plane"></i> Send Email
                            </button>
                        </div>
                        
                        <div class="support-method-card">
                            <div class="support-icon">
                                <i class="fas fa-phone"></i>
                            </div>
                            <h3>Phone Support</h3>
                            <p>Call us for immediate assistance</p>
                            <a href="tel:+15551234567" class="btn btn-outline">
                                <i class="fas fa-phone"></i> +1 (555) 123-4567
                            </a>
                        </div>
                    </div>
                    
                    <div class="support-form-container">
                        <h3 style="margin-bottom: 1rem;">Send Support Request</h3>
                        <form id="supportRequestForm" class="support-form">
                            <div class="form-group">
                                <label>Subject *</label>
                                <input type="text" id="supportSubject" required placeholder="What can we help you with?">
                            </div>
                            <div class="form-group">
                                <label>Category *</label>
                                <select id="supportCategory" required>
                                    <option value="">Select category</option>
                                    <option value="technical">Technical Issue</option>
                                    <option value="billing">Billing Question</option>
                                    <option value="device">Device Setup</option>
                                    <option value="account">Account Help</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Message *</label>
                                <textarea id="supportMessage" rows="5" required placeholder="Please describe your issue or question in detail..."></textarea>
                            </div>
                            <div class="form-group checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="supportUrgent">
                                    <span>Mark as urgent</span>
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Send Request
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h2>Change Password</h2>
                </div>
                <form class="settings-form" id="passwordChangeForm">
                    <div class="form-group">
                        <label>Current Password</label>
                        <input type="password" id="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="newPassword" required>
                    </div>
                    <div class="form-group">
                        <label>Confirm New Password</label>
                        <input type="password" id="confirmPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </form>
            </div>
        </section>
    </main>

    <script src="data-protection.js"></script>
    <script src="invoice.js"></script>
    <script src="email-notifications.js"></script>
    <script src="dashboard.js"></script>
    <link rel="stylesheet" href="support-bot.css">
    <script src="support-bot.js"></script>
</body>
</html>


